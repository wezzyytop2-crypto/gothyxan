<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHOP — GOTYXAN-PRO</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    
    <script src="firebase-config.js"></script> 
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span>GOTYXAN</span><span>-PRO</span>
            </a>
            <ul class="nav-menu" id="main-nav-menu">
                <li><a href="index.html">HOME</a></li>
                <li><a href="shop.html" class="active">SHOP</a></li>
                <li><a href="cart.html">CART <span class="cart-count">0</span></a></li>
                
                <li id="auth-link-1"><a href="login.html">LOGIN</a></li>
                <li id="auth-link-2"><a href="register.html">REGISTER</a></li>
            </ul>
        </div>
    </nav>
    <section class="shop-section">
        <div class="container">
            <h2 class="section-title">COLLECTION</h2>

            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">ALL BRANDS</button>
                <button class="filter-tab" data-filter="RICK OWENS">RICK OWENS</button>
                <button class="filter-tab" data-filter="BALENCIAGA">BALENCIAGA</button>
                <button class="filter-tab" data-filter="MAISON MARGIELA">MAISON MARGIELA</button>
                <button class="filter-tab" data-filter="ANN DEMEULEMEESTER">ANN DEMEULEMEESTER</button>
                <button class="filter-tab" data-filter="YOHJI YAMAMOTO">YOHJI YAMAMOTO</button>
                <button class="filter-tab" data-filter="RAF SIMONS">RAF SIMONS</button>
            </div>

            <div id="products-grid" class="products-grid">
                <p class="loading-message">Loading products...</p>
            </div>
            
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <p>© 2024 GOTYXAN-PRO — BERLIN</p>
        </div>
    </footer>

    <script>
        // Переменные должны быть определены в firebase-config.js
        const auth = firebase.auth();
        const db = firebase.firestore(); 

        const productsGrid = document.getElementById('products-grid');
        let allProducts = []; // Массив для хранения всех загруженных товаров

        // --- 1. ФУНКЦИЯ ЗАГРУЗКИ ТОВАРОВ ИЗ FIRESTORE ---
        async function fetchAndDisplayProducts(filterBrand = 'all') {
            productsGrid.innerHTML = '<p class="loading-message">Loading products...</p>';

            try {
                // Если товары еще не загружены, загружаем их
                if (allProducts.length === 0) {
                    const snapshot = await db.collection('products').orderBy('createdAt', 'desc').get();
                    snapshot.forEach(doc => {
                        allProducts.push({ id: doc.id, ...doc.data() });
                    });
                }
                
                // Фильтруем товары
                const productsToDisplay = filterBrand === 'all'
                    ? allProducts
                    : allProducts.filter(p => p.brand.toUpperCase() === filterBrand.toUpperCase());


                if (productsToDisplay.length === 0) {
                    productsGrid.innerHTML = '<p class="loading-message">No products found for this brand.</p>';
                    return;
                }

                productsGrid.innerHTML = ''; // Очищаем

                productsToDisplay.forEach(product => {
                    const priceElement = product.discountPrice 
                        ? `<p class="product-price"><span>€${product.price.toFixed(2)}</span> €${product.discountPrice.toFixed(2)}</p>`
                        : `<p class="product-price">€${product.price.toFixed(2)}</p>`;
                    
                    const productHtml = `
                        <a href="product.html?id=${product.id}" class="product-card">
                            <img src="${product.imageUrl}" alt="${product.name}" class="product-image">
                            <div class="product-info">
                                <p class="product-brand">${product.brand.toUpperCase()}</p>
                                <h3 class="product-name">${product.name}</h3>
                                ${priceElement}
                            </div>
                        </a>
                    `;
                    productsGrid.insertAdjacentHTML('beforeend', productHtml);
                });

            } catch (error) {
                // Здесь мы ловим и ошибку "db is not defined", если она еще не исправлена
                productsGrid.innerHTML = `<p class="error-message">Error loading products: ${error.message}</p>`;
                console.error("Error loading documents: ", error);
            }
        }
        
        // --- 2. ЛОГИКА ФИЛЬТРАЦИИ ---
        document.querySelectorAll('.filter-tab').forEach(button => {
            button.addEventListener('click', function() {
                // Смена активной кнопки
                document.querySelectorAll('.filter-tab').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                // Запуск загрузки с новым фильтром
                const filter = this.getAttribute('data-filter');
                fetchAndDisplayProducts(filter);
            });
        });

        // --- 3. ЛОГИКА ДИНАМИЧЕСКОЙ НАВИГАЦИИ (скопирована с index.html) ---
        function updateNavigation(user) {
            const authLink1 = document.getElementById('auth-link-1');
            const authLink2 = document.getElementById('auth-link-2');

            authLink1.innerHTML = '';
            authLink2.innerHTML = '';

            if (user) {
                authLink1.innerHTML = `<a href="profile.html">PROFILE</a>`;
                authLink2.innerHTML = `<a href="#" onclick="logoutUser(event)">LOG OUT</a>`;
            } else {
                authLink1.innerHTML = `<a href="login.html">LOGIN</a>`;
                authLink2.innerHTML = `<a href="register.html">REGISTER</a>`;
            }
        }
        
        function logoutUser(event) {
            event.preventDefault(); 
            auth.signOut().then(() => {
                alert("You have been successfully logged out.");
                window.location.reload(); 
            }).catch((error) => {
                console.error("Logout error:", error);
                alert("Error during logout.");
            });
        }
        
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('gotyxan_cart') || '[]');
            const count = cart.reduce((total, item) => total + item.quantity, 0);
            document.querySelectorAll('.cart-count').forEach(el => {
                el.textContent = count;
            });
        }
        
        // --- 4. ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ ---
        document.addEventListener('DOMContentLoaded', () => {
            // Запускаем загрузку всех товаров по умолчанию
            fetchAndDisplayProducts('all'); 
            
            // Запускаем логику навигации
            auth.onAuthStateChanged((user) => {
                updateNavigation(user);
            });
            updateCartCount();
        });
    </script>
</body>
</html>