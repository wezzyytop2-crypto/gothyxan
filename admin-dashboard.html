<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN DASHBOARD — GOTYXAN-PRO</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body>
    <section class="admin-dashboard-section">
        <div class="container">
            <h1 class="admin-title">ADMIN DASHBOARD</h1>
            
            <div class="admin-tabs">
                <button class="tab-button active" data-tab="products"><i class="fas fa-boxes"></i> Products</button>
                <button class="tab-button" data-tab="orders"><i class="fas fa-receipt"></i> Orders</button>
                <button class="tab-button" data-tab="analytics"><i class="fas fa-chart-line"></i> Analytics</button>
                <button class="tab-button logout" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>

            <div id="products" class="tab-content" style="display: block;">
                <h2 class="content-title">Add/Edit Product</h2>

                <form id="product-form" class="admin-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Product Name</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group">
                            <label for="brand">Brand</label>
                            <input type="text" id="brand" required>
                        </div>
                        <div class="form-group">
                            <label for="price">Price (€)</label>
                            <input type="number" id="price" required min="1">
                        </div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <input type="text" id="category" required>
                        </div>
                        <div class="form-group">
                            <label for="imageUrl">Image URL (Main)</label>
                            <input type="url" id="imageUrl" required>
                        </div>
                        <div class="form-group">
                            <label for="discountPrice">Discount Price (€) (Optional)</label>
                            <input type="number" id="discountPrice" min="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" rows="5" required></textarea>
                    </div>

                    <p id="form-message" class="message success-message" style="display: none;"></p>
                    <button type="submit" class="btn btn-full save-button">SAVE PRODUCT</button>
                </form>

                <h2 class="content-title" style="margin-top: 50px;">Current Products</h2>
                <div id="product-list-preview" class="product-list-preview">
                    <p class="loading-message">Loading products...</p>
                </div>
            </div>

            <div id="orders" class="tab-content">
                <h2 class="content-title">Orders Management</h2>
                <p>Order data will appear here once the Checkout page is integrated with Firestore.</p>
            </div>

            <div id="analytics" class="tab-content">
                <h2 class="content-title">Sales Analytics</h2>
                <p>Analytics dashboards will be built here.</p>
            </div>

        </div>
    </section>

    <script>
        // Переменные db и auth должны быть определены в firebase-config.js
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ----------------------------------------------------
        // 1. ПРОВЕРКА АДМИН-ДОСТУПА ПРИ ЗАГРУЗКЕ СТРАНИЦЫ
        // ----------------------------------------------------

        // Проверяем, вошел ли пользователь, и является ли он администратором
        auth.onAuthStateChanged((user) => {
            if (!user) {
                // Если пользователь не вошел, перенаправляем на страницу входа
                window.location.href = 'admin-login.html';
                return;
            }
            
            // ВАЖНО: Мы используем простой подход: если вошел, то админ.
            // В реальном проекте здесь нужна дополнительная проверка (например, по коллекции 'admins' в Firestore).
            
            console.log("Admin logged in:", user.email);
            // Загружаем список товаров сразу после успешного входа
            loadProducts();
        });

        function adminLogout() {
            auth.signOut().then(() => {
                window.location.href = 'admin-login.html';
            }).catch((error) => {
                console.error("Logout error:", error);
            });
        }
        
        // ----------------------------------------------------
        // 2. ЛОГИКА СОХРАНЕНИЯ ТОВАРА В FIRESTORE
        // ----------------------------------------------------
        const productForm = document.getElementById('product-form');
        const formMessage = document.getElementById('form-message');

        productForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const productData = {
                name: document.getElementById('name').value,
                brand: document.getElementById('brand').value,
                price: parseFloat(document.getElementById('price').value),
                category: document.getElementById('category').value,
                imageUrl: document.getElementById('imageUrl').value,
                discountPrice: document.getElementById('discountPrice').value ? parseFloat(document.getElementById('discountPrice').value) : null,
                description: document.getElementById('description').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('products').add(productData);
                formMessage.textContent = `Product "${productData.name}" saved successfully!`;
                formMessage.style.display = 'block';
                productForm.reset(); // Очистить форму
                loadProducts(); // Обновить список
            } catch (error) {
                formMessage.textContent = `Error saving product: ${error.message}`;
                formMessage.classList.remove('success-message');
                formMessage.classList.add('error-message');
                formMessage.style.display = 'block';
                console.error("Error adding document: ", error);
            }
        });


        // ----------------------------------------------------
        // 3. ЛОГИКА ЗАГРУЗКИ ТОВАРОВ (ДЛЯ ПРЕДПРОСМОТРА)
        // ----------------------------------------------------
        const productListPreview = document.getElementById('product-list-preview');

        async function loadProducts() {
            productListPreview.innerHTML = '<p class="loading-message">Loading products...</p>';
            try {
                const snapshot = await db.collection('products').orderBy('createdAt', 'desc').get();
                
                if (snapshot.empty) {
                    productListPreview.innerHTML = '<p class="loading-message">No products found. Add your first product above!</p>';
                    return;
                }

                productListPreview.innerHTML = ''; // Очищаем
                
                snapshot.forEach(doc => {
                    const product = doc.data();
                    const itemId = doc.id;

                    const itemElement = document.createElement('div');
                    itemElement.className = 'product-list-item';
                    itemElement.innerHTML = `
                        <img src="${product.imageUrl}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;">
                        <div class="product-details">
                            <p><strong>${product.name}</strong> (${product.brand})</p>
                            <p>Price: €${product.price} ${product.discountPrice ? `(Sale: €${product.discountPrice})` : ''}</p>
                        </div>
                        <button class="btn-delete" data-id="${itemId}">DELETE</button>
                    `;
                    productListPreview.appendChild(itemElement);
                });

                // Добавляем слушателей для кнопок удаления
                document.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', deleteProduct);
                });

            } catch (error) {
                productListPreview.innerHTML = `<p class="error-message">Error loading products: ${error.message}</p>`;
                console.error("Error loading documents: ", error);
            }
        }
        
        // ----------------------------------------------------
        // 4. ЛОГИКА УДАЛЕНИЯ ТОВАРА
        // ----------------------------------------------------
        async function deleteProduct(event) {
            const itemId = event.target.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await db.collection('products').doc(itemId).delete();
                    alert('Product deleted successfully!');
                    loadProducts(); // Обновить список после удаления
                } catch (error) {
                    alert(`Error deleting product: ${error.message}`);
                    console.error("Error deleting document: ", error);
                }
            }
        }
        
        // ----------------------------------------------------
        // 5. ЛОГИКА ПЕРЕКЛЮЧЕНИЯ ВКЛАДОК
        // ----------------------------------------------------
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                // Скрываем все содержимое
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                // Деактивируем все кнопки
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Показываем нужную вкладку
                const targetId = this.getAttribute('data-tab');
                document.getElementById(targetId).style.display = 'block';
                this.classList.add('active');
            });
        });

    </script>
</body>
</html>